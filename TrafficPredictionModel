import pandas as pd
import matplotlib.pyplot as plt
import sys, getopt

sys._enablelegacywindowsfsencoding()

# 1066, 1067, 1068
detectorIds = []
inputfile = ""
printToFile = False

detectorRows = pd.DataFrame({'DetectorID':[],
               'VehicleClassID':[], 'Timestamp':[], 'Flow':[], 'Speed':[], 'Occupancy':[], 'Confidence':[], 'Tdiff':[],
               'TimeCycle':[], 'NoVehicles':[], 'Headway':[], 'MeasuresIncluded':[]})

def readfile():
    global detectorRows
    print("Analyzing",inputfile + "...")
    booleans = []
    i = 1
    for chunk in pd.read_csv(inputfile, sep=";", decimal=",", encoding="utf-8", chunksize=1000000, names=["DetectorID",
               "VehicleClassID", "Timestamp", "Flow", "Speed", "Occupancy", "Confidence", "Tdiff",
               "TimeCycle", "NoVehicles", "Headway", "MeasuresIncluded"], index_col=False):
        print("handling chunk: " + repr(i))
        i = i+1
        booleans.clear()
        for detId in chunk.DetectorID:
            if detId in detectorIds:
              booleans.append(True)
            else:
              booleans.append(False)
        detectorRows = pd.concat([detectorRows, chunk[booleans]])

    print(detectorRows)
    print(detectorRows.shape)


def printToCSV():
    toPrint = pd.DataFrame(detectorRows, columns=["VehicleClassID", "NoVehicles", "Timestamp"])
    outputfile = "data_detectorId"
    for detector in detectorIds:
        outputfile += "_" + str(detector)
    filename = outputfile + ".csv"

    print("Writing to", filename)
    toPrint.to_csv(filename, sep=';')



def main(argv):
    global inputfile, detectorIds, printToFile
    try:
        opts, args = getopt.getopt(argv,"i:d:o",["inputfile=","detectors=","outputfile"])
    except getopt.GetoptError:
        sys.exit(2)
    for opt, arg in opts:
        if opt == "-h":
            sys.exit()
        elif opt in ("-i", "--inputfile"):
            inputfile = arg
        elif opt in ("-o", "--outputfile"):
            printToFile = True
        elif opt in ("-d", "--detectors"):
            detectorIds = arg.split(',')
            #list string -> int
            detectorIds = list(map(int, detectorIds))

if __name__ == "__main__":
    main(sys.argv[1:])
    readfile()
    if printToFile:
        printToCSV()


# with open("gbgData_201401.csv", 'r') as fp:
#     dum1 = pd.read_csv(fp, sep=";", decimal=",",  encoding="utf-8", names=["DetectorID",
#           "VehicleClassID", "Timestamp", "Flow", "Speed", "Occupancy", "Confidence", "Tdiff"
#           "TimeCycle", "NoVehicles", "Headway", "MeasuresIncluded"], index_col=False)
#
# dataShape = dum1.shape
# print(dataShape)

# booleans = []
# for detId in dum1.DetectorID:
#  if detId == 20000:
#      booleans.append(True)
#  else:
#      booleans.append(False)
#
# print(len(booleans))
#
# indices = pd.Series(booleans)
#
# print(dum1[indices])
#print(dum1)