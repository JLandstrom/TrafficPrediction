import matplotlib
import pandas as pd
import matplotlib.pyplot as plt
import sys, getopt



sys._enablelegacywindowsfsencoding()

AllColumns = ["DetectorID", "VehicleClassID", "Timestamp", "Flow", "Speed", "Occupancy", "Confidence", "Tdiff",
               "TimeCycle", "NoVehicles", "Headway", "MeasuresIncluded"]

SelectedColumns = ["DetectorID", "VehicleClassID", "Timestamp", "Flow", "NoVehicles"]
detectorIds = []
inputfile = ""
printToFile = False
detectorRows = pd.DataFrame()
filename = ""

def readfile():
    global detectorRows
    print("Analyzing",inputfile + "...")
    booleans = []
    i = 1
    appendedFrames = []
    for chunk in pd.read_csv(inputfile, sep=";", decimal=",", encoding="utf-8", chunksize=1000000, names=AllColumns, index_col=False):
        print("handling chunk: " + repr(i))
        i = i+1
        booleans.clear()
        for detId in chunk.DetectorID:
            if detId in detectorIds:
              booleans.append(True)
            else:
              booleans.append(False)
        appendedFrames.append(chunk[booleans])

    detectorRows = pd.concat(appendedFrames)
    print(detectorRows)
    print(detectorRows.shape)


def printToCSV():
    toPrint = pd.DataFrame(detectorRows, columns=SelectedColumns)
    print("Writing to", filename)
    toPrint.to_csv(filename, sep=';', index=False)
    return filename


def main(argv):
    global inputfile, detectorIds, printToFile, filename

    try:
        opts, args = getopt.getopt(argv,"i:d:o",["inputfile=","detectors=","outputfile="])
    except getopt.GetoptError:
        sys.exit(2)
    for opt, arg in opts:
        if opt == "-h":
            sys.exit()
        elif opt in ("-i", "--inputfile"):
            inputfile = arg
        elif opt in ("-o", "--outputfile"):
            filename = arg
            printToFile = True
        elif opt in ("-d", "--detectors"):
            detectorIds = arg.split(',')
            #list string -> int
            detectorIds = list(map(int, detectorIds))

def PlotDetectorData(filename):
    dataFrame = pd.read_csv(filename, sep=";", decimal=",", encoding="utf-8", header=0)
    dataFrame = dataFrame[dataFrame['VehicleClassID'] == 0].groupby(['Timestamp'])[['Flow', 'NoVehicles']].sum()
    print(dataFrame)
    dataFrame.plot()

def CreateFileName():
    outputfile = "data_detectorId"
    for detector in detectorIds:
        outputfile += "_" + str(detector)
    filename = outputfile + ".csv"

if __name__ == "__main__":
    plotData = True
    readNeeded = False
    main(sys.argv[1:])

    if filename == "":
        CreateFileName()
    if readNeeded:
        readfile()
        if printToFile:
            printToCSV()
    if plotData:
        PlotDetectorData(filename)


#take in filename